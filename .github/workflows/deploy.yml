name: Production

# Ce workflow se déclenche automatiquement lors d'un push sur la branche main
on:
  push:
    branches:
      - main

# Variables d'environnement utilisées dans le workflow
# Ces variables sont partagées par tous les jobs du workflow
env:
  REGISTRY: ghcr.io # GitHub Container Registry - où sont stockées nos images Docker
  IMAGE_NAME: ${{ github.repository }} # Nom du repository GitHub (ex: aboubacar3012/santu-hub-cicd-example)

# ================================================================================================
# JOBS DE CONSTRUCTION (BUILD) - Ces jobs créent les images Docker
# ================================================================================================

jobs:
  # Job 1: Construction et publication de l'image
  # Ce job construit une image Docker contenant notre application Next.js
  # et la publie automatiquement sur GitHub Container Registry
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: read
      actions: read

    steps:
      # Étape 1: Télécharger le code source du commit qui a déclenché le workflow
      - name: Checkout repository
        uses: actions/checkout@v4

      # Étape 2: Supprimer l'ancien fichier .env s'il existe
      # Le fichier .env contient les variables d'environnement de l'application
      - name: Clean old .env file
        run: rm -f .env

      # Étape 3: Créer le fichier .env avec les variables GitHub
      # Récupère les variables depuis les repository variables GitHub et les injecte dans .env
      - name: Create .env file from GitHub variables
        run: |
          {
            echo "VARIABLE1=${VARIABLE1}"
            echo "VARIABLE2=${VARIABLE2}"
            echo "VARIABLE3=${VARIABLE3}"
          } > .env
        env:
          VARIABLE1: ${{ vars.VARIABLE1 }}
          VARIABLE2: ${{ vars.VARIABLE2 }}
          VARIABLE3: ${{ vars.VARIABLE3 }}

      # Étape 4: Afficher le contenu du fichier .env pour débugger
      # Cela nous permet de vérifier que toutes les variables sont bien définies
      - name: Debug .env
        run: |
          echo "------ Contenu de .env ------"
          cat .env
          echo "----------------------------------------"

      # Étape 5: Se connecter au registre Docker GitHub Container Registry
      # Cette authentification est nécessaire pour publier l'image Docker
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.PAT_GITHUB_TOKEN }}

      # Étape 6: Rendre le script exécutable
      - name: Make script executable
        run: chmod +x build-image.sh

      # Étape 7: Construire et publier l'image
      # Le script build-image.sh construit l'image Docker et la publie automatiquement
      # sur GitHub Container Registry avec un tag basé sur l'auteur et la date
      - name: Build and push image
        run: ./build-image.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
